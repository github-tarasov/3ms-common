# Тестовое задание – Набор микросервисов
В рамках задания разработаны три взаимодействующих между собой микросервиса MS1, MS2, MS3.

### Основа взаимодействия
Микросервисы взаимодействуют между собой путем последовательной передачи сообщения message следующего формата:
```json
{
  “session_id”: integer,
  “service1_timestamp”: datetime,
  “service2_timestamp”: datetime,
  “service3_timestamp”: datetime,
  “end_timestamp”: datetime (не используется)
}
```
где session_id - идентификатор сеанса взаимодействия, задаваемый MS1, оставшиеся поля – отметки времени прохождения сообщения через
оставшиеся сервисы включая MS1 в конце.

### Инициализация – MS1
1. MS1 устанавливает соединение с базой данных
2. MS1 устанавливает соединение с MS2 по протоколу WebSocket
3. MS1 ожидает запрос HTTP GET /start
4. MS1 ожидает запрос HTTP GET /stop (обработка этого запроса должна привести к прерыванию цикла)

### Цикл взаимодействия
1. После получения запроса HTTP GET /start MS1 записывает это сообщение в лог-файл и также выводит его в консоль.  
   MS1 создает в БД новый цикл взаимодействия (таблица Interaction) c идентификатором взаимодействия.  
   Затем создается цикл (сеанс) взаимодействия (таблица Session) с основными параметрами.
2. MS1 создает message с заполненными нужными данными полями session_id и service1_timestamp
3. MS1 отправляет message в MS2 через WebSocket
4. MS1 ожидает HTTP POST /store с message
5. MS2 принимает message от MS1, записывает в поле сообщения service2_timestamp текущее время и отправляет сообщение в MS3 через
   топик брокера Kafka
6. MS3 забирает message из топика, записывает в поле service3_timestamp текущее время и отправляет message в MS1 HTTP POST /store  
   Цикл взаимодействия повторяется в течение заданного интервала взаимодействия.  
   Длительность интервала взаимодействия задается в секундах параметром в конфигурационном файле.  
   Завершение взаимодействия выводится на консоль с выводом следующих параметров:  
   - общее время взаимодействия;  
   - количество сообщений, сгенерированных во время взаимодействия.

### Требования
Для реализации используются только стабильные LTS (или последнии официально поддерживаемые) версии библиотек и компонентов.  
Для целей трассировки предусмотрена в микросервисах отправку span-сообщений в систему Jaeger для каждого входящего сообщения.  
В качестве БД используется СУБД MariaDB. После остановки контейнеров с микросервисами и окружением, кроме MariaDB, база данных доступна для просмотра средствами СУБД.  
Запуск микросервисов и окружения необходимо производить только в контейнерах.  
Обеспечено минимум 86% покрытие тестами кода микросервисов.

### Структура БД

#### Таблица Interaction: Группы циклов (сеансов) взаимодействия
- interaction_id Long Идентификатор группы циклов (сеансов) взаимодействия

#### Таблица Session: Один цикл (сеанс) взаимодействия
- sessionId Integer Идентификатор одного цикла (сеанса) взаимодействия (согласно ТЗ, хотя более подходит тип Long)
- interaction_id Long Идентификатор группы циклов (сеансов) взаимодействия
- service1Timestamp Date Время прохождения сообщения через MS1 в начале
- service2Timestamp Date Время прохождения сообщения через MS2
- service3Timestamp Date Время прохождения сообщения через MS3
- endTimestamp Date Время прохождения сообщения через MS1 в конце

### Порядок запуска
1) В папке /env/local/MariaDB: ```docker-compose up -d```
2) В папке /env/local/Kafka: ```docker-compose up -d```
3) В папке /env/local/Jaeger: ```docker-compose up -d```
4) В папке /env/local/3ms: ```docker-compose up -d```

#### Просмотр логов сервиса MS1:
- ```docker logs -f ms1```  
- или файлы в папке /env/local/3ms/log/ms1


### Ссылки
* [Swagger UI](http://localhost:8001/swagger-ui/index.html)
* [Jaeger UI](http://localhost:16686)
* [Git Hub](https://github.com/github-tarasov)
* [Docker Hub](https://hub.docker.com/repositories/docker4tarasov)
